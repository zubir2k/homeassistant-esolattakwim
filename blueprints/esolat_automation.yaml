blueprint:
  name: eSolat Automation Blueprint
  description: Blueprint for eSolat prayer time notifications with speaker alerts.
  domain: automation
  input:
    calendar_entity:
      name: eSolat Calendar Entity
      description: Entity ID of the eSolat calendar.
      selector:
        entity:
          domain: calendar
    speaker_type:
      name: Speaker Type
      description: Type of speaker to use for the alert (Google or Alexa).
      selector:
        select:
          options:
            - Google
            - Alexa
    speaker_entity:
      name: Speaker Entity
      description: The media player entity for the speaker.
      selector:
        entity:
          domain: media_player
    audio_url:
      name: Audio URL
      description: URL of the audio file to play for the alert.
      selector:
        text:

trigger:
  - platform: template
    id: esolat_prayer
    value_template: >-
      {{ now().strftime('%H:%M') ==
      as_timestamp(state_attr(blueprint.input.calendar_entity, (state_attr(blueprint.input.calendar_entity,'current') | lower))) | timestamp_custom('%H:%M') }}

  - platform: template
    id: esolat_reminder
    value_template: >-
      {{ (as_local(now()).strftime("%s") | int + (15*60)) |
      timestamp_custom("%H:%M", false) ==
      as_timestamp(state_attr(blueprint.input.calendar_entity, (state_attr(blueprint.input.calendar_entity,'next') | lower))) | timestamp_custom('%H:%M') }}

condition: []

action:
  - variables:
      prayer: >-
        {% set prayer_map = {'Imsak':'Imsak', 'Fajr':'Subuh', 'Syuruk':'Syuruk',
        'Dhuhr':'Zohor', 'Asr':'Asar', 'Maghrib':'Maghrib', 'Isha':'Isyak'} %}{%
        set prayer_name = state_attr(blueprint.input.calendar_entity,'current') %}
        {{ prayer_map.get(prayer_name, 'Unknown') }}
      prayer_next: >-
        {% set prayer_map = {'Imsak':'Imsak', 'Fajr':'Subuh', 'Syuruk':'Syuruk',
        'Dhuhr':'Zohor', 'Asr':'Asar', 'Maghrib':'Maghrib', 'Isha':'Isyak'} %}{%
        set prayer_name = state_attr(blueprint.input.calendar_entity,'next') %}
        {{ prayer_map.get(prayer_name, 'Unknown') }}

  - choose:
      - conditions:
          - condition: trigger
            id: esolat_prayer
        sequence:
          - service: persistent_notification.create
            data:
              notification_id: esolat_notify
              title: >-
                🕋 eSolat - Waktu {{ prayer }}
              message: >-
                {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
          - service: media_player.play_media
            data:
              entity_id: !input speaker_entity
              media_content_id: !input audio_url
              media_content_type: music

      - conditions:
          - condition: trigger
            id: esolat_reminder
        sequence:
          - service: persistent_notification.create
            data:
              notification_id: esolat_remind
              title: >-
                🕋 eSolat - Waktu {{ prayer_next }} ⏰
              message: >-
                {{ now().strftime('%-I:%M %p') }} - Azan {{ prayer_next }} akan berkumandang sebentar nanti.
mode: single
