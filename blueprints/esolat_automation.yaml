blueprint:
  name: 🕋 eSolat Automation Blueprint
  description: v1.0 beta5 - Blueprint for eSolat prayer time notifications with speaker alerts.
  author: zubir2k
  domain: automation
  input:
    select_esolattakwim:
      name: eSolat Calendar Entity
      description: Please ensure the eSolat Takwim has been configured.
      default: calendar.esolat_takwim
      selector:
        entity:
          domain: calendar
          integration: esolattakwim
    select_speaker_type:
      name: Speaker Type
      description: Type of speaker to use for the alert (Google or Alexa).
      default: Google
      selector:
        select:
          options:
            - Google
            - Alexa
    select_speaker_entity:
      name: Speaker Entity
      description: The media player entity for the speaker.
      selector:
        entity:
          domain: media_player
    slider_reminder:
      name: Azan Reminder
      description: Minute reminder before prayer time (0 to disable).
      default: 15
      selector:
        number:
          min: 0
          max: 30
          mode: slider
    txt_audio_azan:
      name: Azan
      description: URL of your preferred azan audio file.
      selector:
        text: 
      default: "https://github.com/zubir2k/HomeAssistantAdzan/raw/refs/heads/main/audio/azan_alexa.mp3"
    txt_audio_azansubuh:
      name: Azan Subuh
      description: URL of your preferred azan audio file for Subuh.
      selector:
        text: 
      default: "https://github.com/zubir2k/HomeAssistantAdzan/raw/refs/heads/main/audio/azansubuh_alexa.mp3"
    chk_notification_options:
      name: Notification Options
      description: Select notification types to use.
      default: ["Persistent Notification"]
      selector:
        select:
          multiple: true
          options:
            - Persistent Notification
            - Mobile Notification
            - Audio Notification

variables:
  esolattakwim: !input select_esolattakwim
  speaker_type: !input select_speaker_type
  speaker_entity: !input select_speaker_entity
  reminder: !input slider_reminder
  audio_azan: !input txt_audio_azan
  audio_azansubuh: !input txt_audio_azansubuh
  notification_options: !input chk_notification_options
  current: "{{ states[esolattakwim].attributes.current | lower }}"
  next: "{{ states[esolattakwim].attributes.next | lower }}"
  prayer: >-
    {% set prayer_map = {'imsak':'Imsak', 'fajr':'Subuh', 'syuruk':'Syuruk',
    'dhuhr':'Zohor', 'asr':'Asar', 'maghrib':'Maghrib', 'isha':'Isyak'} %}
    {{ prayer_map[(current | title)] }}
  prayer_next: >-
    {% set prayer_map = {'imsak':'Imsak', 'fajr':'Subuh', 'syuruk':'Syuruk',
    'dhuhr':'Zohor', 'asr':'Asar', 'maghrib':'Maghrib', 'isha':'Isyak'} %}
    {{ prayer_map[(next | title)] }}

mode: parallel

trigger:
  # At Prayer Time Triggers
  - platform: time
    at: "{{ state_attr(esolattakwim, 'fajr') }}"
    id: fajr_at
  - platform: time
    at: "{{ state_attr(esolattakwim, 'dhuhr') }}"
    id: dhuhr_at
  - platform: time
    at: "{{ state_attr(esolattakwim, 'asr') }}"
    id: asr_at
  - platform: time
    at: "{{ state_attr(esolattakwim, 'maghrib') }}"
    id: maghrib_at
  - platform: time
    at: "{{ state_attr(esolattakwim, 'isha') }}"
    id: isha_at
  # Before Prayer Time Triggers
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(state_attr(esolattakwim, 'fajr')) - (reminder * 60) <= as_timestamp(now()) }}
    id: fajr_before
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(state_attr(esolattakwim, 'dhuhr')) - (reminder * 60) <= as_timestamp(now()) }}
    id: dhuhr_before
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(state_attr(esolattakwim, 'asr')) - (reminder * 60) <= as_timestamp(now()) }}
    id: asr_before
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(state_attr(esolattakwim, 'maghrib')) - (reminder * 60) <= as_timestamp(now()) }}
    id: maghrib_before
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(state_attr(esolattakwim, 'isha')) - (reminder * 60) <= as_timestamp(now()) }}
    id: isha_before

condition:
  - condition: template
    value_template: >-
      {% set at_ids = ['fajr_at', 'dhuhr_at', 'asr_at', 'maghrib_at', 'isha_at'] %}
      {% set before_ids = ['fajr_before', 'dhuhr_before', 'asr_before', 'maghrib_before', 'isha_before'] %}
      {{ trigger.id in at_ids or (trigger.id in before_ids and reminder > 0) }}

action:
  - choose:
      - conditions:
          - condition: trigger
            id:
              - fajr_at
              - dhuhr_at
              - asr_at
              - maghrib_at
              - isha_at
        sequence:
          parallel:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ 'Persistent Notification' in notification_options }}"
                  sequence:
                    - action: persistent_notification.create
                      data:
                        notification_id: "esolat_notify_{{ trigger.id }}"
                        title: "🕋 eSolat - Waktu {{ prayer }}"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Mobile Notification' in notification_options }}"
                  sequence:
                    - action: notify.notify
                      data:
                        title: "🕋 eSolat - Waktu {{ prayer }}"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Audio Notification' in notification_options }}"
                  sequence:
                    - choose:
                        - conditions:
                            - condition: template
                              value_template: "{{ speaker_type == 'Google' }}"
                          sequence:
                            - action: media_player.play_media
                              target:
                                entity_id: "{{ speaker_entity }}"
                              data:
                                media_content_type: audio/mp3
                                media_content_id: >-
                                  {% if prayer == 'Subuh' %}{{ audio_azansubuh }}{% else %}{{ audio_azan }}{% endif %}
                                extra:
                                  title: "Azan {{ prayer }}"
                                  thumb: "https://i.imgur.com/1U9Ehvr.png"
                        - conditions:
                            - condition: template
                              value_template: "{{ speaker_type == 'Alexa' }}"
                          sequence:
                            - action: notify.alexa_media
                              continue_on_error: true
                              data:
                                data:
                                  type: tts
                                target: "{{ speaker_entity | replace('media_player.', 'notify.alexa_media_') }}"
                                message: >-
                                  <audio src='{% if prayer == "Subuh" %}https://dl.sndup.net/rkrk/azansubuh_alexa.mp3{% else %}https://dl.sndup.net/c7sgg/azan_alexa.mp3{% endif %}'/>

      - conditions:
          - condition: trigger
            id:
              - fajr_before
              - dhuhr_before
              - asr_before
              - maghrib_before
              - isha_before
        sequence:
          parallel:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ 'Persistent Notification' in notification_options }}"
                  sequence:
                    - action: persistent_notification.create
                      data:
                        notification_id: "esolat_remind_{{ trigger.id }}"
                        title: "🕋 eSolat - Waktu {{ prayer_next }} ⏰"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Azan {{ prayer_next }} akan berkumandang sebentar nanti.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Mobile Notification' in notification_options }}"
                  sequence:
                    - action: notify.notify
                      data:
                        title: "🕋 eSolat - Waktu {{ prayer_next }} ⏰"
                        message: >-
                          {{ as_timestamp(state_attr(esolattakwim, next)) | timestamp_custom('%-I:%M %p') }} - Azan {{ prayer_next }} akan berkumandang sebentar nanti.

  # Debug Notification (optional, comment out if not needed)
  - action: persistent_notification.create
    data:
      notification_id: "esolat_debug"
      title: "🕋 [DEBUG] eSolat - Variables Check ✅"
      message: >-
        **Config**{{ '\n' }}
        esolattakwim - {{ esolattakwim }}{{ '\n' }}
        speaker_type - {{ speaker_type }}{{ '\n' }}
        speaker_entity - {{ speaker_entity }}{{ '\n' }}
        reminder - {{ reminder }}{{ '\n' }}
        notification_options - {{ notification_options }}{{ '\n' }}{{ '\n' }}
        
        **Audio**{{ '\n' }}
        audio_azan - {{ audio_azan }}{{ '\n' }}
        audio_azansubuh - {{ audio_azansubuh }}{{ '\n' }}{{ '\n' }}
        
        **Prayer Time**{{ '\n' }}
        current - {{ current }}{{ '\n' }}
        next - {{ next }}{{ '\n' }}
        prayer - {{ prayer }}{{ '\n' }}
        prayer_next - {{ prayer_next }}{{ '\n' }}
