blueprint:
  name: 🕋 eSolat Automation Blueprint
  description: v1.0 beta6 - Blueprint for eSolat prayer time notifications with speaker alerts.
  author: zubir2k
  domain: automation
  input:
    select_esolattakwim:
      name: eSolat Calendar Entity
      description: Please ensure the eSolat Takwim has been configured.
      default: calendar.esolat_takwim
      selector:
        entity:
          domain: calendar
          integration: esolattakwim
    select_speaker_type:
      name: Speaker Type
      description: Type of speaker to use for the alert (Google or Alexa).
      default: Google
      selector:
        select:
          options:
            - Google
            - Alexa
    select_speaker_entity:
      name: Speaker Entity
      description: The media player entity for the speaker.
      selector:
        entity:
          domain: media_player
    slider_reminder:
      name: Azan Reminder
      description: Minute reminder before prayer time (0 to disable).
      default: 15
      selector:
        number:
          min: 0
          max: 30
          mode: slider
    txt_audio_azan:
      name: Azan
      description: URL of your preferred azan audio file.
      selector:
        text: 
      default: "https://github.com/zubir2k/HomeAssistantAdzan/raw/refs/heads/main/audio/azan_alexa.mp3"
    txt_audio_azansubuh:
      name: Azan Subuh
      description: URL of your preferred azan audio file for Subuh.
      selector:
        text: 
      default: "https://github.com/zubir2k/HomeAssistantAdzan/raw/refs/heads/main/audio/azansubuh_alexa.mp3"
    chk_notification_options:
      name: Notification Options
      description: Select notification types to use.
      default: ["Persistent Notification"]
      selector:
        select:
          multiple: true
          options:
            - Persistent Notification
            - Mobile Notification
            - Audio Notification

variables:
  esolattakwim: !input select_esolattakwim
  speaker_type: !input select_speaker_type
  speaker_entity: !input select_speaker_entity
  reminder: !input slider_reminder
  audio_azan: !input txt_audio_azan
  audio_azansubuh: !input txt_audio_azansubuh
  notification_options: !input chk_notification_options
  prayer_times:
    fajr: "{{ states[esolattakwim].attributes.fajr }}"
    dhuhr: "{{ states[esolattakwim].attributes.dhuhr }}"
    asr: "{{ states[esolattakwim].attributes.asr }}"
    maghrib: "{{ states[esolattakwim].attributes.maghrib }}"
    isha: "{{ states[esolattakwim].attributes.isha }}"
  prayer_map:
    imsak: Imsak
    fajr: Subuh
    syuruk: Syuruk
    dhuhr: Zohor
    asr: Asar
    maghrib: Maghrib
    isha: Isyak

mode: parallel

trigger:
  # At Prayer Time Triggers
  - platform: template
    value_template: >-
      {{ as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.fajr) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.fajr) + 60 }}
    id: fajr_at
  - platform: template
    value_template: >-
      {{ as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.dhuhr) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.dhuhr) + 60 }}
    id: dhuhr_at
  - platform: template
    value_template: >-
      {{ as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.asr) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.asr) + 60 }}
    id: asr_at
  - platform: template
    value_template: >-
      {{ as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.maghrib) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.maghrib) + 60 }}
    id: maghrib_at
  - platform: template
    value_template: >-
      {{ as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.isha) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.isha) + 60 }}
    id: isha_at
  # Before Prayer Time Triggers
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.fajr) - (reminder * 60) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.fajr) - (reminder * 60) + 60 }}
    id: fajr_before
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.dhuhr) - (reminder * 60) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.dhuhr) - (reminder * 60) + 60 }}
    id: dhuhr_before
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.asr) - (reminder * 60) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.asr) - (reminder * 60) + 60 }}
    id: asr_before
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.maghrib) - (reminder * 60) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.maghrib) - (reminder * 60) + 60 }}
    id: maghrib_before
  - platform: template
    value_template: >-
      {{ reminder > 0 and as_timestamp(now()) >= as_timestamp(states[esolattakwim].attributes.isha) - (reminder * 60) and 
         as_timestamp(now()) < as_timestamp(states[esolattakwim].attributes.isha) - (reminder * 60) + 60 }}
    id: isha_before

condition:
  - condition: template
    value_template: >-
      {% set at_ids = ['fajr_at', 'dhuhr_at', 'asr_at', 'maghrib_at', 'isha_at'] %}
      {% set before_ids = ['fajr_before', 'dhuhr_before', 'asr_before', 'maghrib_before', 'isha_before'] %}
      {{ trigger.id in at_ids or (trigger.id in before_ids and reminder > 0) }}

action:
  - variables:
      current_prayer: >-
        {% if trigger.id.startswith('fajr') %}fajr
        {% elif trigger.id.startswith('dhuhr') %}dhuhr
        {% elif trigger.id.startswith('asr') %}asr
        {% elif trigger.id.startswith('maghrib') %}maghrib
        {% elif trigger.id.startswith('isha') %}isha
        {% endif %}
      prayer_name: "{{ prayer_map[current_prayer] }}"
  - choose:
      - conditions:
          - condition: trigger
            id:
              - fajr_at
              - dhuhr_at
              - asr_at
              - maghrib_at
              - isha_at
        sequence:
          parallel:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ 'Persistent Notification' in notification_options }}"
                  sequence:
                    - action: persistent_notification.create
                      data:
                        notification_id: "esolat_notify_{{ trigger.id }}"
                        title: "🕋 eSolat - Waktu {{ prayer_name }}"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer_name }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Mobile Notification' in notification_options }}"
                  sequence:
                    - action: notify.notify
                      data:
                        title: "🕋 eSolat - Waktu {{ prayer_name }}"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer_name }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Audio Notification' in notification_options }}"
                  sequence:
                    - choose:
                        - conditions:
                            - condition: template
                              value_template: "{{ speaker_type == 'Google' }}"
                          sequence:
                            - action: media_player.play_media
                              target:
                                entity_id: "{{ speaker_entity }}"
                              data:
                                media_content_type: audio/mp3
                                media_content_id: >-
                                  {% if prayer_name == 'Subuh' %}{{ audio_azansubuh }}{% else %}{{ audio_azan }}{% endif %}
                                extra:
                                  title: "Azan {{ prayer_name }}"
                                  thumb: "https://i.imgur.com/1U9Ehvr.png"
                        - conditions:
                            - condition: template
                              value_template: "{{ speaker_type == 'Alexa' }}"
                          sequence:
                            - action: notify.alexa_media
                              continue_on_error: true
                              data:
                                data:
                                  type: tts
                                target: "{{ speaker_entity | replace('media_player.', 'notify.alexa_media_') }}"
                                message: >-
                                  <audio src='{% if prayer_name == "Subuh" %}https://dl.sndup.net/rkrk/azansubuh_alexa.mp3{% else %}https://dl.sndup.net/c7sgg/azan_alexa.mp3{% endif %}'/>

      - conditions:
          - condition: trigger
            id:
              - fajr_before
              - dhuhr_before
              - asr_before
              - maghrib_before
              - isha_before
        sequence:
          parallel:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ 'Persistent Notification' in notification_options }}"
                  sequence:
                    - action: persistent_notification.create
                      data:
                        notification_id: "esolat_remind_{{ trigger.id }}"
                        title: "🕋 eSolat - Waktu {{ prayer_name }} ⏰"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Azan {{ prayer_name }} akan berkumandang sebentar nanti.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Mobile Notification' in notification_options }}"
                  sequence:
                    - action: notify.notify
                      data:
                        title: "🕋 eSolat - Waktu {{ prayer_name }} ⏰"
                        message: >-
                          {{ as_timestamp(states[esolattakwim].attributes[current_prayer]) | timestamp_custom('%-I:%M %p') }} - Azan {{ prayer_name }} akan berkumandang sebentar nanti.
