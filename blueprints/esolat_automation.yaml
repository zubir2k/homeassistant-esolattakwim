blueprint:
  name: ðŸ•‹ eSolat Automation Blueprint
  description: v1.0 beta3d - Blueprint for eSolat prayer time notifications with speaker alerts.
  author: Zubir Jamal
  domain: automation
  input:
    esolattakwim:
      name: eSolat Calendar Entity
      description: Please ensure the eSolat Takwim has been configured.
      default: calendar.esolat_takwim
      selector:
        entity:
          domain: calendar
          integration: esolattakwim
    speaker_type:
      name: Speaker Type
      description: Type of speaker to use for the alert (Google or Alexa).
      default: Google
      selector:
        select:
          options:
            - Google
            - Alexa
    speaker_entity:
      name: Speaker Entity
      description: The media player entity for the speaker.
      selector:
        entity:
          domain: media_player
    reminder:
      name: Azan Reminder
      description: Minute reminder before prayer time
      default: 15
      selector:
        number:
          min: 5
          max: 30
          mode: slider
    audio_azan:
      name: Azan
      description: URL of your preferred azan audio file.
      selector:
        text: 
      default: "https://dl.sndup.net/c7sgg/azan_alexa.mp3"
    audio_azansubuh:
      name: Azan Subuh
      description: URL of your preferred azan audio file.
      selector:
        text: 
      default: "https://dl.sndup.net/rkrk/azansubuh_alexa.mp3"
    notification_options:
      name: Notification Options
      description: Select notification types to use.
      default: "Persistent Notification"
      selector:
        select:
          multiple: true
          options:
            - Persistent Notification
            - Mobile Notification
            - Audio Notification

variables:
  esolattakwim: !input esolattakwim
  current24h: >-
    {{ as_timestamp(state_attr(esolattakwim,'current')) | timestamp_custom('%H:%M') }}
  next24h: >-
    {{ as_timestamp(state_attr(esolattakwim,'next')) | timestamp_custom('%H:%M') }}
  speaker_type: !input speaker_type
  speaker_entity: !input speaker_entity
  reminder: !input reminder
  audio_azan: !input audio_azan
  audio_azansubuh: !input audio_azansubuh
  notification_options: !input notification_options
            
trigger:
  - platform: template
    id: esolat_prayer
    value_template: >-
      {{ now().strftime('%H:%M') == current24h }}

  - platform: template
    id: esolat_reminder
    value_template: >-
      {{ (as_local(now()).strftime("%s") | int + (reminder*60)) |
      timestamp_custom("%H:%M", false) ==
      next24h }}

condition: []

action:
  - variables:
      prayer: >-
        {% set prayer_map = {'Imsak':'Imsak', 'Fajr':'Subuh', 'Syuruk':'Syuruk',
        'Dhuhr':'Zohor', 'Asr':'Asar', 'Maghrib':'Maghrib', 'Isha':'Isyak'} %}{{
        prayer_map[state_attr(esolattakwim,'current')] }}
      prayer_next: >-
        {% set prayer_map = {'Imsak':'Imsak', 'Fajr':'Subuh', 'Syuruk':'Syuruk',
        'Dhuhr':'Zohor', 'Asr':'Asar', 'Maghrib':'Maghrib', 'Isha':'Isyak'} %}{{
        prayer_map[state_attr(esolattakwim,'next')] }}
  - action: persistent_notification.create
    data:
      notification_id: esolat_check
      title: >-
        ðŸ•‹ [DEBUG] eSolat - Variables Check âœ…
      message: >-
        prayer - {{ prayer }}{{ '\n' }}
        prayer_next - {{ prayer_next }}{{ '\n' }}
        prayer_next - {{ prayer_next }}{{ '\n' }}
        esolattakwim - {{ esolattakwim }}{{ '\n' }}
        current24h - {{ current24h }}{{ '\n' }}
        next24h - {{ next24h }}{{ '\n' }}
        speaker_type - {{ speaker_type }}{{ '\n' }}
        speaker_entity - {{ speaker_entity }}{{ '\n' }}
        reminder - {{ reminder }}{{ '\n' }}
        audio_azan - {{ audio_azan }}{{ '\n' }}
        audio_azansubuh - {{ audio_azansubuh }}{{ '\n' }}
        notification_options - {{ notification_options }}
      
  - choose:
      - conditions:
          - condition: trigger
            id: esolat_prayer
        sequence:
          parallel:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'Persistent Notification' in notification_options }}
              sequence:
                - action: persistent_notification.create
                  data:
                    notification_id: esolat_notify
                    title: >-
                      ðŸ•‹ eSolat - Waktu {{ prayer }}
                    message: >-
                      {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'Mobile Notification' in notification_options }}
              sequence:
                - action: notify.notify
                  data:
                    title: >-
                      ðŸ•‹ eSolat - Waktu {{ prayer }}
                    message: >-
                      {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'Audio Notification' in notification_options }}
              sequence:
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ speaker_type == 'Google' }}"
                      sequence:
                        - action: media_player.play_media
                          target:
                            entity_id: !input speaker_entity
                          data:
                            media_content_type: audio/mp3
                            media_content_id: >-
                              {% if prayer == "Subuh" 
                              %}{{ audio_azansubuh }}{% else 
                              %}{{ audio_azan }}{% endif %}
                            extra:
                              title: Azan {{ prayer }}
                              thumb: https://i.imgur.com/1U9Ehvr.png                              
                    - conditions:
                        - condition: template
                          value_template: "{{ speaker_type == 'Alexa' }}"
                      sequence:
                        - action: notify.alexa_media
                          continue_on_error: true
                          data:
                            data:
                              type: tts
                            target: >-
                              {% set speaker = speaker_entity %}
                              {{ speaker | replace("media_player.","notify.alexa_media_") }}
                            message: >-
                              <audio src='{% if prayer == "Subuh" 
                              %}https://dl.sndup.net/rkrk/azansubuh_alexa.mp3{% else
                              %}https://dl.sndup.net/c7sgg/azan_alexa.mp3{% endif %}'/>

      - conditions:
          - condition: trigger
            id: esolat_reminder
        sequence:
          parallel:
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'Persistent Notification' in notification_options }}
              sequence:
                - action: persistent_notification.create
                  data:
                    notification_id: esolat_remind
                    title: >-
                      ðŸ•‹ eSolat - Waktu {{ prayer_next }} â°
                    message: >-
                      {{ now().strftime('%-I:%M %p') }} - Azan {{ prayer_next }} akan berkumandang sebentar nanti.
            - conditions:
                - condition: template
                  value_template: >-
                    {{ 'Mobile Notification' in notification_options }}
              sequence:
                - action: notify.notify
                  data:
                    title: >-
                      ðŸ•‹ eSolat - Waktu {{ prayer_next }} â°
                    message: >-
                      {{ as_timestamp(state_attr(esolattakwim, (state_attr(esolattakwim,'next') | lower))) | timestamp_custom('%-I:%M %p') }} - Azan {{ prayer_next }} akan berkumandang sebentar nanti.
mode: single
