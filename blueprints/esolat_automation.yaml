blueprint:
  name: ðŸ•‹ eSolat Automation Blueprint
  description: v1.0 beta8 - Simplified blueprint for eSolat prayer time notifications with speaker alerts.
  author: zubir2k
  domain: automation
  input:
    select_esolattakwim:
      name: eSolat Calendar Entity
      description: Please ensure the eSolat Takwim has been configured.
      default: calendar.esolat_takwim
      selector:
        entity:
          domain: calendar
          integration: esolattakwim
    select_speaker_type:
      name: Speaker Type
      description: Type of speaker to use for the alert (Google or Alexa).
      default: Google
      selector:
        select:
          options:
            - Google
            - Alexa
    select_speaker_entity:
      name: Speaker Entity
      description: The media player entity for the speaker.
      selector:
        entity:
          domain: media_player
    slider_reminder:
      name: Azan Reminder
      description: Minute reminder before prayer time (0 to disable).
      default: 15
      selector:
        number:
          min: 0
          max: 30
          mode: slider
    txt_audio_azan:
      name: Azan
      description: URL of your preferred azan audio file.
      selector:
        text: 
      default: "https://github.com/zubir2k/HomeAssistantAdzan/raw/refs/heads/main/audio/azan_alexa.mp3"
    txt_audio_azansubuh:
      name: Azan Subuh
      description: URL of your preferred azan audio file for Subuh.
      selector:
        text: 
      default: "https://github.com/zubir2k/HomeAssistantAdzan/raw/refs/heads/main/audio/azansubuh_alexa.mp3"
    chk_notification_options:
      name: Notification Options
      description: Select notification types to use.
      default: ["Persistent Notification"]
      selector:
        select:
          multiple: true
          options:
            - Persistent Notification
            - Mobile Notification
            - Audio Notification

variables:
  esolattakwim: !input select_esolattakwim
  speaker_type: !input select_speaker_type
  speaker_entity: !input select_speaker_entity
  reminder: !input slider_reminder
  audio_azan: !input txt_audio_azan
  audio_azansubuh: !input txt_audio_azansubuh
  notification_options: !input chk_notification_options
  prayer_map:
    imsak: Imsak
    fajr: Subuh
    syuruk: Syuruk
    dhuhr: Zohor
    asr: Asar
    maghrib: Maghrib
    isha: Isyak

mode: parallel

trigger:
  - platform: state
    entity_id: !input select_esolattakwim
    attribute: fajr  # Trigger on any attribute change (fajr as a representative)

condition:
  - condition: or
    conditions:
      # At Prayer Time Conditions
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'fajr') %}
          {{ ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) and as_timestamp(now()) < as_timestamp(ts) + 60 }}
        alias: "Fajr at"
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'dhuhr') %}
          {{ ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) and as_timestamp(now()) < as_timestamp(ts) + 60 }}
        alias: "Dhuhr at"
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'asr') %}
          {{ ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) and as_timestamp(now()) < as_timestamp(ts) + 60 }}
        alias: "Asr at"
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'maghrib') %}
          {{ ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) and as_timestamp(now()) < as_timestamp(ts) + 60 }}
        alias: "Maghrib at"
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'isha') %}
          {{ ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) and as_timestamp(now()) < as_timestamp(ts) + 60 }}
        alias: "Isha at"
      # Before Prayer Time Conditions
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'fajr') %}
          {{ reminder > 0 and ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) - (reminder * 60) and as_timestamp(now()) < as_timestamp(ts) - (reminder * 60) + 60 }}
        alias: "Fajr before"
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'dhuhr') %}
          {{ reminder > 0 and ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) - (reminder * 60) and as_timestamp(now()) < as_timestamp(ts) - (reminder * 60) + 60 }}
        alias: "Dhuhr before"
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'asr') %}
          {{ reminder > 0 and ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) - (reminder * 60) and as_timestamp(now()) < as_timestamp(ts) - (reminder * 60) + 60 }}
        alias: "Asr before"
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'maghrib') %}
          {{ reminder > 0 and ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) - (reminder * 60) and as_timestamp(now()) < as_timestamp(ts) - (reminder * 60) + 60 }}
        alias: "Maghrib before"
      - condition: template
        value_template: >-
          {% set ts = state_attr(esolattakwim, 'isha') %}
          {{ reminder > 0 and ts != 'unknown' and as_timestamp(now()) >= as_timestamp(ts) - (reminder * 60) and as_timestamp(now()) < as_timestamp(ts) - (reminder * 60) + 60 }}
        alias: "Isha before"

action:
  - variables:
      current_prayer: >-
        {% set prayers = [
          ('fajr', state_attr(esolattakwim, 'fajr')),
          ('dhuhr', state_attr(esolattakwim, 'dhuhr')),
          ('asr', state_attr(esolattakwim, 'asr')),
          ('maghrib', state_attr(esolattakwim, 'maghrib')),
          ('isha', state_attr(esolattakwim, 'isha'))
        ] %}
        {% set now_ts = as_timestamp(now()) %}
        {% for prayer, ts in prayers if ts != 'unknown' %}
          {% if now_ts >= as_timestamp(ts) and now_ts < as_timestamp(ts) + 60 %}
            {{ prayer }}
          {% elif reminder > 0 and now_ts >= as_timestamp(ts) - (reminder * 60) and now_ts < as_timestamp(ts) - (reminder * 60) + 60 %}
            {{ prayer }}
          {% endif %}
        {% endfor %}
      prayer_name: "{{ prayer_map[current_prayer] }}"
      is_at_prayer: >-
        {% set ts = state_attr(esolattakwim, current_prayer) %}
        {{ as_timestamp(now()) >= as_timestamp(ts) and as_timestamp(now()) < as_timestamp(ts) + 60 }}
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ is_at_prayer }}"
        sequence:
          parallel:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ 'Persistent Notification' in notification_options }}"
                  sequence:
                    - action: persistent_notification.create
                      data:
                        notification_id: "esolat_notify_{{ current_prayer }}_at"
                        title: "ðŸ•‹ eSolat - Waktu {{ prayer_name }}"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer_name }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Mobile Notification' in notification_options }}"
                  sequence:
                    - action: notify.notify
                      data:
                        title: "ðŸ•‹ eSolat - Waktu {{ prayer_name }}"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Sekarang telah masuk waktu {{ prayer_name }} bagi kawasan ini dan kawasan yang sama waktu dengannya.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Audio Notification' in notification_options }}"
                  sequence:
                    - choose:
                        - conditions:
                            - condition: template
                              value_template: "{{ speaker_type == 'Google' }}"
                          sequence:
                            - action: media_player.play_media
                              target:
                                entity_id: "{{ speaker_entity }}"
                              data:
                                media_content_type: audio/mp3
                                media_content_id: >-
                                  {% if prayer_name == 'Subuh' %}{{ audio_azansubuh }}{% else %}{{ audio_azan }}{% endif %}
                                extra:
                                  title: "Azan {{ prayer_name }}"
                                  thumb: "https://i.imgur.com/1U9Ehvr.png"
                        - conditions:
                            - condition: template
                              value_template: "{{ speaker_type == 'Alexa' }}"
                          sequence:
                            - action: notify.alexa_media
                              continue_on_error: true
                              data:
                                data:
                                  type: tts
                                target: "{{ speaker_entity | replace('media_player.', 'notify.alexa_media_') }}"
                                message: >-
                                  <audio src='{% if prayer_name == "Subuh" %}https://dl.sndup.net/rkrk/azansubuh_alexa.mp3{% else %}https://dl.sndup.net/c7sgg/azan_alexa.mp3{% endif %}'/>

      - conditions:
          - condition: template
            value_template: "{{ not is_at_prayer }}"
        sequence:
          parallel:
            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ 'Persistent Notification' in notification_options }}"
                  sequence:
                    - action: persistent_notification.create
                      data:
                        notification_id: "esolat_remind_{{ current_prayer }}_before"
                        title: "ðŸ•‹ eSolat - Waktu {{ prayer_name }} â°"
                        message: >-
                          {{ now().strftime('%-I:%M %p') }} - Azan {{ prayer_name }} akan berkumandang sebentar nanti.
                - conditions:
                    - condition: template
                      value_template: "{{ 'Mobile Notification' in notification_options }}"
                  sequence:
                    - action: notify.notify
                      data:
                        title: "ðŸ•‹ eSolat - Waktu {{ prayer_name }} â°"
                        message: >-
                          {{ as_timestamp(state_attr(esolattakwim, current_prayer)) | timestamp_custom('%-I:%M %p') }} - Azan {{ prayer_name }} akan berkumandang sebentar nanti.
